pipeline {
    agent any

    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Tag of the Docker image to deploy')
        string(name: 'GIT_TOKEN_CREDENTIALS_ID', defaultValue: '3aa5b976-a8a1-4c9d-abb5-5241f0778707', description: 'Git Token Credentials ID')
        string(name: 'REPO_URL', defaultValue: 'https://github.com/karimelhou/helloworld.git', description: 'Repository URL')
        string(name: 'BRANCH_NAME', defaultValue: 'main', description: 'Branch Name')
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    git credentialsId: params.GIT_TOKEN_CREDENTIALS_ID, url: params.REPO_URL, branch: params.BRANCH_NAME
                }
            }
        }

        stage('Update Manifest') {
            steps {
                script {
                    sh "sed -i 's/karimelhou\\/mydocker:.*/karimelhou\\/mydocker:${params.IMAGE_TAG}/' k8s-manifest.yaml"
                }
            }
        }

        stage('Commit and Push Changes') {
            steps {
                script {
                    withCredentials([string(credentialsId: params.GIT_TOKEN_CREDENTIALS_ID, variable: 'GIT_TOKEN')]) {
                        sh '''
                            set -x
                            git config user.email "elhoumaini1@gmail.com"
                            git config user.name "karimelhou"
                            git add k8s-manifest.yaml
                            git commit -m "Update image tag to ${params.IMAGE_TAG}"
                            git -c http.extraheader="AUTHORIZATION: bearer ${GIT_TOKEN}" push ${params.REPO_URL} ${params.BRANCH_NAME}
                        '''
                    }
                }
            }
        }
    }
}
